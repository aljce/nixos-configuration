#!/run/current-system/sw/bin/bash +e

DISK="$1"

sudo echo "Ensuring user is root, warning here be dragons turn back now with C-c unless you are sure you want to partition the disk and risk losing data."
echo "You have ten seconds to user interupt"

sleep 10

parted $DISK mklabel gpt
parted -s $DISK mkpart primary fat16 1MiB 513MiB
parted -s $DISK mkpart primary ext4 513MiB 100%
parted -s $DISK set 1 boot on
parted -s $DISK name 1 Boot
parted -s $DISK name 2 Root

PART_ONE="$DISK"1""
PART_TWO="$DISK"2""

cryptsetup luksFormat $PART_TWO
cryptsetup open --type luks $PART_TWO lvm

pvcreate -ff /dev/mapper/lvm

vgcreate vg /dev/mapper/lvm

lvcreate -L 10G vg -n root
lvcreate -L 30G vg -n nix
lvcreate -L 10G vg -n var
lvcreate -l 100%FREE vg -n home

mkfs.vfat -n BOOT $PART_ONE
mkfs.btrfs -L root /dev/mapper/vg-root
mkfs.btrfs -L nix  /dev/mapper/vg-nix
mkfs.btrfs -L var  /dev/mapper/vg-var
mkfs.btrfs -L home /dev/mapper/vg-home

mount /dev/mapper/vg-root /mnt
mkdir /mnt/boot /mnt/nix /mnt/var /mnt/home
mount $PART_ONE /mnt/boot
mount /dev/mapper/vg-nix  /mnt/nix
mount /dev/mapper/vg-var  /mnt/var
mount /dev/mapper/vg-home /mnt/home

nixos-generate-config --root /mnt
